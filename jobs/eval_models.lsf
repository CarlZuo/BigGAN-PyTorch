#BSUB -L /bin/bash
#BSUB -J "EvalModels"
#BSUB -o "runs/EvalModels.%J"
#BSUB -n 1
#BSUB -R "span[ptile=1]"
#BSUB -gpu "num=4"
#BSUB -q "normal"
#BSUB -x

#
# Setup User Environement (Python, WMLCE virtual environment etc)
#
HOME2=/nobackup/users/$(whoami)
PYTHON_VIRTUAL_ENVIRONMENT=wmlce-1.6.2
CONDA_ROOT=$HOME2/anaconda3

source ${CONDA_ROOT}/etc/profile.d/conda.sh
conda activate $PYTHON_VIRTUAL_ENVIRONMENT
export EGO_TOP=/opt/ibm/spectrumcomputing

TRAINFILE=$HOME2/evalfile
rm -rf ${TRAINFILE}

cat > set.sh << EoF_s
#! /bin/sh
# Set up the GPUs; only one process per node should do this
if [ \${OMPI_COMM_WORLD_LOCAL_RANK} -eq 0 ]; then
  sudo ppc64_cpu --smt=2                 # Set the SMT mode to 2
  ppc64_cpu --smt                        # Verify the SMT mode
  sudo nvidia-smi -rac                   # For POWER9+V100
  sudo nvidia-smi --compute-mode=DEFAULT # Set the compute mode to DEFAULT
fi
EoF_s
chmod +x set.sh
mpirun --tag-output ./set.sh

# Run the program
export PAMI_IBV_ADAPTER_AFFINITY=0
export NCCL_SOCKET_IFNAME=ib

python $HOME2/BigGAN-PyTorch/eval_models.py

# Reset the GPUs
cat > reset.sh << EoF_r
#! /bin/sh

if [ \${OMPI_COMM_WORLD_LOCAL_RANK} -eq 0 ]; then
  sudo ppc64_cpu --smt=on                          # SMT mode back to default
  sudo nvidia-smi -rac                             # Clocks back to defaults
  sudo nvidia-smi --compute-mode=EXCLUSIVE_PROCESS # Compute mode back to p10 default
fi
EoF_r
chmod +x reset.sh
mpirun --tag-output ./reset.sh

/bin/rm -f set.sh reset.sh